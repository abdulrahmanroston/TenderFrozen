<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tender Frozen Orders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #f8fafc;
            --dark: #1f2937;
            --background: #f1f5f9;
            --border: #e5e7eb;
            --whatsapp: #25D366;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background);
            margin: 0;
            padding: 0;
            color: var(--dark);
            overflow-x: hidden;
            width: 100%;
        }
        .container {
            max-width: 100%;
            margin: 0 0;
            background: #fff;
            min-height: 100vh;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .header {
            background: var(--dark);
            color: #fff;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
        }
        .header h1 {
            width: fit-content;
            font-size: 1.8rem;
            padding: 0 0;
            font-weight: 600;
        }
        .header-actions {
            display: flex;
            gap: 12px;
        }
        .header-btn {
            background: var(--secondary);
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            font-size: 14px;
        }
        .header-btn:hover {
            background: #9ca3af;
            transform: translateY(-2px);
        }
        .search-bar {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid var(--border);
        }
        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .search-bar input:focus {
            border-color: var(--primary);
            outline: none;
        }
        .settings-panel {
            display: none;
            padding: 20px;
            background: var(--light);
            border-bottom: 1px solid var(--border);
            animation: slideDown 0.3s ease;
        }
        .settings-panel.active {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .settings-panel select,
        .settings-panel input,
        .settings-panel button {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .settings-panel select:focus,
        .settings-panel input:focus {
            border-color: var(--primary);
            outline: none;
        }
        .settings-panel button {
            background: var(--primary);
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s, transform 0.2s;
        }
        .settings-panel button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .status-checkboxes, .user-management-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .status-checkboxes label, .user-management-section label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            color: var(--dark);
        }
        .user-management-section .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fff;
        }
        .user-management-section .user-item .user-info {
            flex-grow: 1;
            margin-right: 10px;
        }
        .user-management-section .user-item .user-actions button {
            margin-left: 5px;
            padding: 4px 8px;
            font-size: 12px;
        }
        .stats {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: #fff;
            border-bottom: 1px solid var(--border);
        }
        .stat-card {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s, border 0.3s;
            cursor: pointer;
            border: 2px solid transparent; /* Add border for active state */
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .stat-card.active {
            background: var(--primary);
            color: #fff;
            border: 2px solid #1d4ed8; /* Darker border for active */
        }
        .stat-card.active h3, .stat-card.active p {
            color: #fff;
        }
        .stat-card h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--dark);
            font-weight: 500;
        }
        .stat-card p {
            margin: 8px 0 0;
            font-size: 1.6rem;
            font-weight: 600;
        }
        .tabs {
            display: flex;
            flex-wrap: no-wrap;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid var(--border);
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: var(--light);
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.3s, color 0.3s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        .tab.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 2px solid #1d4ed8;
        }
        .tab:hover:not(.active) {
            background: var(--border);
        }
        .tab .count {
            background: var(--danger);
            color: #fff;
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 13px;
            margin-left: 8px;
        }
        .tab-content {
            display: none;
            padding: 10px;
        }
        .tab-content.active {
            display: block;
        }
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .order-card {
            background: #fff;
            border-radius: 12px;
            padding: 10px;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .order-card-header h3 {
            margin: 0;
            font-size: 15px;
            color: var(--dark);
            font-weight: 600;
        }
        .order-card-header .status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #fff;
            font-weight: 500;
        }
        .order-card-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
        }
        .order-card-details.active {
            display: block;
        }
        .order-card-details .section {
            margin-bottom: 20px;
        }
        .order-card-details .section h4 {
            margin: 0 0 12px;
            font-size: 1.2rem;
            color: var(--dark);
            font-weight: 600;
        }
        .order-card-details .section p {
            margin: 5px 0;
            font-size: 0.95rem;
            color: var(--secondary);
        }
        .order-card-details .product-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fff;
        }
        .order-card-details .product-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 6px;
            font-weight: 500;
            transition: background 0.3s, transform 0.2s;
            
        }
        .action-btn:hover {
            transform: translateY(-2px);
        }
        .update-status-btn { background: var(--primary); color: #fff; }
        .update-status-btn:hover { background: #2563eb; }
        .edit-products-btn { background: var(--success); color: #fff; }
        .edit-products-btn:hover { background: #059669; }
        .copy-address-btn { background: var(--warning); color: #fff; }
        .copy-address-btn:hover { background: #d97706; }
        .copy-order-btn { background: var(--warning); color: #fff; }
        .copy-order-btn:hover { background: #d97706; }
        .send-address-btn, .send-order-btn {
            background: var(--whatsapp);
            color: #fff;
        }
        .send-address-btn:hover, .send-order-btn:hover {
            background: #128C7E;
        }
        .no-orders {
            text-align: center;
            color: var(--secondary);
            padding: 30px;
            font-size: 16px;
            font-weight: 500;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        .loading-overlay.active {
            display: flex;
        }
        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.0s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @media (max-width: 768px) {
            .container { margin: 3px; border-radius: 8px; }
            .settings-panel { grid-template-columns: 1fr; gap: 12px; }
            .order-card { padding: 15px; }
        }
        @media (min-width: 769px) {
            .container { max-width: 1400px; margin: 30px auto; border-radius: 12px; }
            .header h1 { font-size: 2rem; }
            .settings-panel { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
            .order-card { padding: 25px; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>
    <div class="container">
        <div class="header">
            <div class="header-actions">
                <button class="header-btn" onclick="toggleSettings()"><i class="fas fa-cog"></i> Settings</button>
                <button class="header-btn" onclick="refreshOrders()"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="header-btn" onclick="toggleFullScreen()"><i class="fas fa-expand"></i> Full Screen</button>
            </div>
        </div>
        <div class="search-bar">
            <input type="text" id="customer-filter" placeholder="Search by Customer Name or Email">
        </div>
        <div class="settings-panel" id="settings-panel">
            <div class="status-checkboxes">
                <h4>Filter by Status</h4>
                <label><input type="checkbox" name="status-filter" value="pending"> Pending Payment</label>
                <label><input type="checkbox" name="status-filter" value="processing"> Processing</label>
                <label><input type="checkbox" name="status-filter" value="on-hold"> On Hold</label>
                <label><input type="checkbox" name="status-filter" value="completed"> Completed</label>
                <label><input type="checkbox" name="status-filter" value="cancelled"> Cancelled</label>
                <label><input type="checkbox" name="status-filter" value="refunded"> Refunded</label>
                <label><input type="checkbox" name="status-filter" value="failed"> Failed</label>
            </div>
            <div class="user-management-section" id="user-management-section"> <!-- Updated ID -->
                <h4>Delivery & Order Preparation Users</h4> <!-- Updated Heading -->
                <button id="add-user-btn" style="background: var(--success);"><i class="fas fa-plus"></i> Add User</button>
                <!-- User items will be added here by JS -->
            </div>
            <div>
                <h4>Filter by Date</h4>
                <input type="date" id="date-from" placeholder="From Date">
                <input type="date" id="date-to" placeholder="To Date">
            </div>
            <div>
                <h4>Display Options</h4>
                <input type="number" id="per-page" placeholder="Orders per page (e.g., 20)" min="1" max="100" value="20">
                <select id="sort-by">
                    <option value="date-desc">Date (Newest First)</option>
                    <option value="date-asc">Date (Oldest First)</option>
                    <option value="total-desc">Total (High to Low)</option>
                    <option value="total-asc">Total (Low to High)</option>
                </select>
            </div>
            <div>
                <h4>Actions</h4>
                <button id="save-settings-btn">Save Settings</button>
                <button id="clear-filters-btn" style="background: var(--secondary);"><i class="fas fa-times"></i> Clear Filters</button> <!-- Added Clear Filters Button -->
            </div>
        </div>
        <div class="stats" id="stats"></div>
        <div class="tabs" id="zone-tabs"></div>
        <div id="tab-contents"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const consumer_key = 'ck_f40406bbecba206fc13e711e2f8df86de26dbbc7';
        const consumer_secret = 'cs_62458ae4d624c3a04a515c770345466497fd88a5';
        const storeUrl = 'https://tenderfrozen.com';
        let users = []; // Renamed from localUsers
        const USERS_KEY = 'tenderFrozenDeliveryUsers'; // Updated Key
        const EGYPT_COUNTRY_CODE = '+20';

        // --- User Management --- 

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            let cleaned = phone.trim().replace(/[^0-9+]/g, '');
            if (cleaned.startsWith(EGYPT_COUNTRY_CODE)) {
                return cleaned;
            }
            if (cleaned.startsWith('0')) {
                if (cleaned.length === 11) {
                    return EGYPT_COUNTRY_CODE + cleaned.substring(1);
                }
            }
            if (cleaned.length === 10) {
                return EGYPT_COUNTRY_CODE + cleaned;
            }
            console.warn(`Phone number "${phone}" could not be automatically formatted. Using cleaned value: ${cleaned}`);
            return cleaned;
        }

        function loadUsers() { // Renamed from loadLocalUsers
            const storedUsers = localStorage.getItem(USERS_KEY);
            if (storedUsers) {
                try {
                    users = JSON.parse(storedUsers);
                    console.log('Delivery/Prep users loaded:', users.length);
                } catch (e) {
                    console.error('Error parsing users:', e);
                    users = [];
                    localStorage.removeItem(USERS_KEY);
                }
            } else {
                users = [];
            }
            displayUsers(); // Renamed from displayLocalUsers
        }

        function saveUsers() { // Renamed from saveLocalUsers
            try {
                localStorage.setItem(USERS_KEY, JSON.stringify(users));
            } catch (e) {
                console.error('Error saving users:', e);
                showNotification('Error saving user data. Local storage might be full.', 'error');
            }
        }

        function displayUsers() { // Renamed from displayLocalUsers
            const container = document.getElementById('user-management-section');
            const userItems = container.querySelectorAll('.user-item');
            userItems.forEach(item => item.remove());
            const noUsersP = container.querySelector('p.no-users-msg'); // Added class for specific targeting
            if (users.length === 0) {
                if (!noUsersP) {
                    const p = document.createElement('p');
                    p.textContent = 'No users found.';
                    p.classList.add('no-users-msg'); // Add class
                    container.insertBefore(p, container.querySelector('#add-user-btn'));
                }
            } else {
                if (noUsersP) noUsersP.remove();
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.classList.add('user-item');
                    userItem.dataset.id = user.id;
                    userItem.innerHTML = `
                        <div class="user-info">
                            <strong>${user.name || 'N/A'}</strong><br>
                            <small>Phone: ${user.phone || 'N/A'} | Job: ${user.job || 'N/A'} | Zone: ${user.zone || 'N/A'}</small> <!-- Added Zone -->
                        </div>
                        <div class="user-actions">
                            <button class="action-btn edit-user-btn" style="background: var(--warning); color: #fff;"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-user-btn" style="background: var(--danger); color: #fff;"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    userItem.querySelector('.edit-user-btn').addEventListener('click', () => editUser(user.id)); // Renamed
                    userItem.querySelector('.delete-user-btn').addEventListener('click', () => deleteUser(user.id)); // Renamed
                    container.insertBefore(userItem, container.querySelector('#add-user-btn'));
                });
            }
        }

        function addUser() { // Renamed from addLocalUser
            Swal.fire({
                title: 'Add New User',
                html: `
                    <input id="swal-user-name" class="swal2-input" placeholder="Full Name">
                    <input id="swal-user-phone" class="swal2-input" placeholder="Phone Number (e.g., 01xxxxxxxxx)">
                    <input id="swal-user-job" class="swal2-input" placeholder="Job/Role (e.g., Delivery)">
                    <input id="swal-user-zone" class="swal2-input" placeholder="Zone (e.g., Maadi)"> <!-- Added Zone -->
                `,
                showCancelButton: true,
                confirmButtonText: 'Add',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#ef4444',
                preConfirm: () => {
                    const name = document.getElementById('swal-user-name').value;
                    const phoneInput = document.getElementById('swal-user-phone').value;
                    const job = document.getElementById('swal-user-job').value;
                    const zone = document.getElementById('swal-user-zone').value; // Get Zone

                    if (!name || !phoneInput) {
                        Swal.showValidationMessage('Name and Phone Number are required');
                        return false;
                    }
                    const formattedPhone = formatPhoneNumber(phoneInput);
                    if (!formattedPhone.startsWith(EGYPT_COUNTRY_CODE)) {
                         Swal.showValidationMessage('Please enter a valid Egypt phone number (e.g., 01xxxxxxxxx or +201xxxxxxxxx)');
                         return false;
                    }

                    return { name, phone: formattedPhone, job: job || 'N/A', zone: zone || 'N/A' }; // Added Zone
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const newUser = {
                        id: Date.now().toString(),
                        name: result.value.name,
                        phone: result.value.phone,
                        job: result.value.job,
                        zone: result.value.zone // Added Zone
                    };
                    users.push(newUser);
                    saveUsers();
                    displayUsers();
                    showNotification('User added successfully', 'success');
                }
            });
        }

        function editUser(userId) { // Renamed from editLocalUser
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) {
                showNotification('User not found for editing.', 'error');
                return;
            }
            const user = users[userIndex];

            Swal.fire({
                title: 'Edit User',
                html: `
                    <input id="swal-user-name" class="swal2-input" placeholder="Full Name" value="${user.name || ''}">
                    <input id="swal-user-phone" class="swal2-input" placeholder="Phone Number (e.g., +20...)" value="${user.phone || ''}">
                    <input id="swal-user-job" class="swal2-input" placeholder="Job/Role (e.g., Delivery)" value="${user.job || ''}">
                    <input id="swal-user-zone" class="swal2-input" placeholder="Zone (e.g., Maadi)" value="${user.zone || ''}"> <!-- Added Zone -->
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#ef4444',
                preConfirm: () => {
                    const name = document.getElementById('swal-user-name').value;
                    const phoneInput = document.getElementById('swal-user-phone').value;
                    const job = document.getElementById('swal-user-job').value;
                    const zone = document.getElementById('swal-user-zone').value; // Get Zone

                    if (!name || !phoneInput) {
                        Swal.showValidationMessage('Name and Phone Number are required');
                        return false;
                    }
                    const formattedPhone = formatPhoneNumber(phoneInput);
                     if (!formattedPhone.startsWith(EGYPT_COUNTRY_CODE)) {
                         Swal.showValidationMessage('Please enter a valid Egypt phone number (e.g., 01xxxxxxxxx or +201xxxxxxxxx)');
                         return false;
                    }
                    return { name, phone: formattedPhone, job: job || 'N/A', zone: zone || 'N/A' }; // Added Zone
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    users[userIndex] = {
                        ...user,
                        name: result.value.name,
                        phone: result.value.phone,
                        job: result.value.job,
                        zone: result.value.zone // Added Zone
                    };
                    saveUsers();
                    displayUsers();
                    showNotification('User updated successfully', 'success');
                }
            });
        }

        function deleteUser(userId) { // Renamed from deleteLocalUser
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) {
                showNotification('User not found for deletion.', 'error');
                return;
            }
            const user = users[userIndex];
            Swal.fire({
                title: 'Are you sure?',
                text: `Delete user "${user.name}"? This cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Delete',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    users.splice(userIndex, 1);
                    saveUsers();
                    displayUsers();
                    showNotification('User deleted successfully', 'success');
                }
            });
        }

        // --- End User Management ---

        function sanitizeZoneName(zone) {
            return zone?.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-') || 'unspecified';
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            requestAnimationFrame(() => {
                document.getElementById('loading-overlay').classList.remove('active');
            });
        }

        function loadFilters() {
            const statuses = JSON.parse(localStorage.getItem('status-filter') || '[]');
            const dateFrom = localStorage.getItem('date-from') || '';
            const dateTo = localStorage.getItem('date-to') || '';
            const customer = localStorage.getItem('customer-filter') || '';
            const perPage = localStorage.getItem('per-page') || '20';
            const sortBy = localStorage.getItem('sort-by') || 'date-desc';
            document.querySelectorAll('input[name="status-filter"]').forEach(checkbox => { checkbox.checked = statuses.includes(checkbox.value); });
            document.getElementById('date-from').value = dateFrom;
            document.getElementById('date-to').value = dateTo;
            document.getElementById('customer-filter').value = customer;
            document.getElementById('per-page').value = perPage;
            document.getElementById('sort-by').value = sortBy;
        }

        function saveFiltersAndFetch() {
            const statuses = Array.from(document.querySelectorAll('input[name="status-filter"]:checked')).map(cb => cb.value);
            localStorage.setItem('status-filter', JSON.stringify(statuses));
            localStorage.setItem('date-from', document.getElementById('date-from').value);
            localStorage.setItem('date-to', document.getElementById('date-to').value);
            localStorage.setItem('customer-filter', document.getElementById('customer-filter').value);
            localStorage.setItem('per-page', document.getElementById('per-page').value);
            localStorage.setItem('sort-by', document.getElementById('sort-by').value);
            localStorage.removeItem('active-status-filter');
            fetchOrders();
        }

        function clearFiltersAndFetch() {
            // Clear UI elements
            document.querySelectorAll('input[name="status-filter"]').forEach(checkbox => { checkbox.checked = false; });
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('customer-filter').value = '';
            document.getElementById('per-page').value = '20'; // Reset to default
            document.getElementById('sort-by').value = 'date-desc'; // Reset to default

            // Clear localStorage
            localStorage.removeItem('status-filter');
            localStorage.removeItem('date-from');
            localStorage.removeItem('date-to');
            localStorage.removeItem('customer-filter');
            localStorage.removeItem('per-page');
            localStorage.removeItem('sort-by');
            localStorage.removeItem('active-status-filter');

            // Fetch orders with cleared filters
            fetchOrders();
            showNotification('Filters cleared', 'success');
        }

        function showNotification(message, type) {
            Swal.fire({ title: type === 'success' ? 'Success' : (type === 'error' ? 'Error' : 'Info'), text: message, icon: type, confirmButtonColor: '#10b981', timer: type === 'error' ? 5000 : 800, timerProgressBar: true });
        }

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('active');
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => { console.error('Error entering fullscreen:', err); showNotification('Could not enter fullscreen mode.', 'error'); });
            } else {
                document.exitFullscreen();
            }
        }

        const debounce = (func, delay) => { let debounceTimer; return function(...args) { const context = this; clearTimeout(debounceTimer); debounceTimer = setTimeout(() => func.apply(context, args), delay); } };
        const debouncedSaveFiltersAndFetch = debounce(saveFiltersAndFetch, 800);

        async function fetchOrders(statusFilter = null) {
            showLoading();
            const statuses = statusFilter ? [statusFilter] : JSON.parse(localStorage.getItem('status-filter') || '[]');
            const dateFrom = localStorage.getItem('date-from') || '';
            const dateTo = localStorage.getItem('date-to') || '';
            const customer = localStorage.getItem('customer-filter') || '';
            const perPage = localStorage.getItem('per-page') || '20';
            const sortBy = localStorage.getItem('sort-by') || 'date-desc';
            const perPageNum = parseInt(perPage) || 20;
            const tabsContainer = document.getElementById('zone-tabs');
            const contentsContainer = document.getElementById('tab-contents');
            const statsContainer = document.getElementById('stats');
            tabsContainer.innerHTML = '';
            contentsContainer.innerHTML = '<p class="no-orders">Loading orders...</p>';
            statsContainer.innerHTML = '';
            try {
                let url = `${storeUrl}/wp-json/wc/v3/orders?page=1&per_page=${perPageNum}`;
                if (statuses.length > 0) url += `&status=${statuses.join(',')}`;
                if (dateFrom) url += `&after=${dateFrom}T00:00:00`;
                if (dateTo) url += `&before=${dateTo}T23:59:59`;
                if (customer) url += `&search=${customer}`;
                const [orderBy, order] = sortBy.split('-');
                url += `&orderby=${orderBy}&order=${order}`;
                const response = await fetch(url, { headers: { 'Authorization': 'Basic ' + btoa(`${consumer_key}:${consumer_secret}`) } });
                const contentType = response.headers.get('content-type');
                if (!response.ok) {
                    let errorText = `HTTP error! status: ${response.status}`;
                    try { const errorJson = await response.json(); errorText += `, message: ${errorJson.message || 'Unknown API error'}`; } catch(e) { errorText += `, body: ${await response.text()}`; }
                    throw new Error(errorText);
                }
                if (!contentType || !contentType.includes('application/json')) { throw new Error(`Expected JSON, got ${contentType}: ${await response.text()}`); }
                const orders = await response.json();
                displayStats(orders);
                if (orders.length > 0) { groupAndDisplayOrders(orders); } else { contentsContainer.innerHTML = '<p class="no-orders">No orders found matching your criteria.</p>'; }
            } catch (error) {
                console.error('Detailed error fetching orders:', error);
                contentsContainer.innerHTML = `<div class="no-orders" style="color: var(--danger); border: 1px solid var(--danger); background-color: #fee2e2; padding: 20px; border-radius: 8px;"><p><strong>Error loading orders:</strong></p><p>${error.message}</p><button class="action-btn" onclick="refreshOrders()" style="background: var(--primary); color: #fff; margin-top: 10px;"><i class="fas fa-sync-alt"></i> Retry</button></div>`;
                showNotification(`Error loading orders: ${error.message}`, 'error');
            } finally { hideLoading(); }
        }

        function refreshOrders() { localStorage.removeItem('active-status-filter'); fetchOrders(); showNotification('Refreshing orders...', 'info'); }

        function displayStats(orders) {
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = '';
            const statusConfig = { pending: { name: 'Pending Payment', color: '#f59e0b' }, processing: { name: 'Processing', color: '#3b82f6' }, 'on-hold': { name: 'On Hold', color: '#f97316' }, completed: { name: 'Completed', color: '#10b981' }, cancelled: { name: 'Cancelled', color: '#ef4444' }, refunded: { name: 'Refunded', color: '#6b7280' }, failed: { name: 'Failed', color: '#991b1b' } };
            let activeStatus = localStorage.getItem('active-status-filter') || null;
            let statusCounts = {};
            orders.forEach(order => { statusCounts[order.status] = (statusCounts[order.status] || 0) + 1; });
            Object.keys(statusConfig).forEach(status => {
                const count = statusCounts[status] || 0;
                if (count > 0) {
                    const config = statusConfig[status];
                    const statCard = document.createElement('div');
                    statCard.classList.add('stat-card');
                    if (activeStatus === status) statCard.classList.add('active');
                    statCard.style.backgroundColor = config.color + '22';
                    statCard.innerHTML = `<h3>${config.name}</h3><p>${count}</p>`;
                    statCard.addEventListener('click', () => { if (activeStatus === status) { localStorage.removeItem('active-status-filter'); fetchOrders(); } else { localStorage.setItem('active-status-filter', status); fetchOrders(status); } });
                    statsContainer.appendChild(statCard);
                }
            });
            if (statsContainer.children.length === 0 && orders.length > 0) { statsContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--secondary);">Stats reflect displayed orders.</p>'; }
        }

        function groupOrdersByZone(orders) {
            const groupedOrders = {};
            orders.forEach(order => { const zone = order.billing?.zone_name || order.shipping?.zone_name || 'Unspecified'; if (!groupedOrders[zone]) groupedOrders[zone] = []; groupedOrders[zone].push(order); });
            return groupedOrders;
        }

        function groupAndDisplayOrders(orders) {
            const grouped = groupOrdersByZone(orders);
            const tabsContainer = document.getElementById('zone-tabs');
            const contentsContainer = document.getElementById('tab-contents');
            tabsContainer.innerHTML = ''; contentsContainer.innerHTML = '';
            const zones = Object.keys(grouped).sort();
            if (zones.length === 0) { contentsContainer.innerHTML = '<p class="no-orders">No orders found or could not group by zone.</p>'; return; }
            zones.forEach((zone, index) => {
                const sanitizedZone = sanitizeZoneName(zone);
                const zoneOrders = grouped[zone];
                let tab = document.createElement('div'); tab.classList.add('tab'); tab.dataset.zone = sanitizedZone; tab.innerHTML = `${zone} <span class="count">${zoneOrders.length}</span>`; tab.addEventListener('click', () => switchTab(zone)); tabsContainer.appendChild(tab);
                let content = document.createElement('div'); content.classList.add('tab-content'); content.id = `tab-${sanitizedZone}`; content.innerHTML = `<div class="orders-list" id="orders-${sanitizedZone}"></div>`; contentsContainer.appendChild(content);
                displayOrdersForZone(zoneOrders, `orders-${sanitizedZone}`);
                if (index === 0) { tab.classList.add('active'); content.classList.add('active'); }
            });
        }

        function displayOrdersForZone(orders, containerId) {
            const ordersList = document.getElementById(containerId); if (!ordersList) return; ordersList.innerHTML = '';
            const fragment = document.createDocumentFragment();
            const statusColors = { pending: '#f59e0b', processing: '#3b82f6', 'on-hold': '#f97316', completed: '#10b981', cancelled: '#ef4444', refunded: '#6b7280', failed: '#991b1b' };
            orders.forEach(order => {
                try {
                    const orderCard = document.createElement('div'); orderCard.classList.add('order-card', 'animate__animated', 'animate__fadeIn');
                    const billing = order.billing || {}; const shipping = order.shipping || {};
                    const customerName = `${billing.first_name || shipping.first_name || 'N/A'} ${billing.last_name || shipping.last_name || ''}`.trim() || 'Unknown Customer';
                    const status = order.status || 'Unknown'; const zoneName = billing.zone_name || shipping.zone_name || 'Unspecified'; const locationLink = billing.location || shipping.location || '#';
                    const address = `${billing.address_1 || shipping.address_1 || ''}, ${billing.city || shipping.city || ''}, ${billing.state || shipping.state || ''}, ${billing.postcode || shipping.postcode || ''}, ${billing.country || shipping.country || ''}`.trim().replace(/^,|,$/g, '').replace(/,{2,}/g, ',');
                    let productItemsHtml = '';
                    try {
                        const lineItems = Array.isArray(order.line_items) ? order.line_items : [];
                        productItemsHtml = lineItems.map(item => {
                            const imageSrc = item.image?.src || ''; const imageAlt = item.name || 'Product'; const itemName = item.name || 'Unknown Product'; const itemQuantity = item.quantity || 0;
                            // Removed price from here
                            return `<div class="product-item">${imageSrc ? `<img src="${imageSrc}" alt="${imageAlt}" loading="lazy" />` : '<div style="width: 60px; height: 60px; background: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #aaa;"><i class="fas fa-image"></i></div>'}<div><span class="name">${itemName}</span><span class="details"> × ${itemQuantity}</span></div></div>`;
                        }).join('');
                    } catch (error) { console.error(`Error processing line items for order ${order.id}:`, error); productItemsHtml = '<p style="color: var(--danger);">Error loading products</p>'; }
                    orderCard.innerHTML = `
                        <div class="order-card-header"><h3>${customerName} ( #${order.id || 'N/A'})</h3><span class="status" style="background-color: ${statusColors[status] || '#6b7280'};">${status}</span></div>
                        <div class="order-card-details" id="details-${order.id}">
                            <div class="section"><h4>Order Details</h4><p><strong>Date:</strong> ${order.date_created ? new Date(order.date_created).toLocaleString() : 'N/A'}</p><p><strong>Total:</strong> ${parseFloat(order.total || 0).toFixed(2)} ${order.currency || ''}</p></div>
                            <div class="section"><h4>Customer</h4><p><strong>Email:</strong> ${billing.email || 'N/A'}</p><p><strong>Phone:</strong> ${billing.phone || 'N/A'}</p></div>
                            <div class="section"><h4>Address</h4><p><strong>Address:</strong> ${address || 'N/A'}</p><p><strong>Location:</strong> <a href="${locationLink}" target="_blank" ${locationLink === '#' ? 'style="color: grey; pointer-events: none; text-decoration: line-through;"' : ''}>Open Location</a></p><p><strong>Zone:</strong> ${zoneName}</p></div>
                            <div class="section"><h4>Products (${(order.line_items || []).length})</h4>${productItemsHtml || '<p>No products</p>'}</div>
                            <div class="section action-buttons">
                                <button class="action-btn copy-address-btn"><i class="fas fa-copy"></i> Copy Address</button>
                                <button class="action-btn copy-order-btn"><i class="fas fa-copy"></i> Copy Order</button>
                                <button class="action-btn send-address-btn"><i class="fab fa-whatsapp"></i> Send Address</button>
                                <button class="action-btn send-order-btn"><i class="fab fa-whatsapp"></i> Send Order</button>
                                <button class="action-btn update-status-btn"><i class="fas fa-sync-alt"></i> Update Status</button>
                                <button class="action-btn edit-products-btn"><i class="fas fa-edit"></i> Edit Products</button>
                            </div>
                        </div>
                    `;
                    const detailsDiv = orderCard.querySelector(`#details-${order.id}`);
                    if (detailsDiv) {
                        const copyAddressBtn = detailsDiv.querySelector('.copy-address-btn'); const copyOrderBtn = detailsDiv.querySelector('.copy-order-btn'); const sendAddressBtn = detailsDiv.querySelector('.send-address-btn'); const sendOrderBtn = detailsDiv.querySelector('.send-order-btn'); const updateStatusBtn = detailsDiv.querySelector('.update-status-btn'); const editProductsBtn = detailsDiv.querySelector('.edit-products-btn');
                        if (copyAddressBtn) copyAddressBtn.addEventListener('click', (e) => { e.stopPropagation(); copyAddress(order); });
                        if (copyOrderBtn) copyOrderBtn.addEventListener('click', (e) => { e.stopPropagation(); copyOrder(order); });
                        if (sendAddressBtn) sendAddressBtn.addEventListener('click', (e) => { e.stopPropagation(); sendToWhatsApp(order, 'address'); });
                        if (sendOrderBtn) sendOrderBtn.addEventListener('click', (e) => { e.stopPropagation(); sendToWhatsApp(order, 'order'); });
                        if (updateStatusBtn) updateStatusBtn.addEventListener('click', (e) => { e.stopPropagation(); openStatusModal(order.id, order.status); });
                        if (editProductsBtn) editProductsBtn.addEventListener('click', (e) => { e.stopPropagation(); openProductsModal(order.id, order.line_items); });
                    }
                    orderCard.addEventListener('click', () => { const details = document.getElementById(`details-${order.id}`); if (details) details.classList.toggle('active'); });
                    fragment.appendChild(orderCard);
                } catch (error) {
                    console.error(`Error rendering order ${order.id}:`, error, error.stack);
                    const errorCard = document.createElement('div'); errorCard.classList.add('order-card', 'animate__animated', 'animate__fadeIn');
                    errorCard.innerHTML = `<div class="order-card-header"><h3>Error Loading Order #${order.id || 'Unknown'}</h3><span class="status" style="background-color: #991b1b">Error</span></div><div class="order-card-details active" id="details-${order.id}"><p style="color: var(--danger);">Unable to display order details: ${error.message}.</p><p><small>Check console.</small></p><button class="action-btn retry-btn" style="background: #3b82f6; color: #fff;" onclick="event.stopPropagation(); fetchOrders();"><i class="fas fa-sync-alt"></i> Retry Load</button></div>`;
                    fragment.appendChild(errorCard);
                }
            });
            requestAnimationFrame(() => { ordersList.appendChild(fragment); });
        }

        function switchTab(zone) {
            const sanitizedZone = sanitizeZoneName(zone);
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const tabToActivate = document.querySelector(`.tab[data-zone="${sanitizedZone}"]`);
            const contentToActivate = document.querySelector(`#tab-${sanitizedZone}`);
            if (tabToActivate) tabToActivate.classList.add('active');
            if (contentToActivate) contentToActivate.classList.add('active');
        }

        function copyAddress(order, forWhatsApp = false) {
            const billing = order.billing || {}; const shipping = order.shipping || {};
            const address = `
العميل: ${billing.first_name || shipping.first_name || ''} ${billing.last_name || shipping.last_name || ''}

رقم الهاتف: ${billing.phone || 'N/A'}

العنوان: ${billing.address_1 || shipping.address_1 || ''},

${billing.city || shipping.city || ''}, ${billing.state || shipping.state || ''}, ${billing.postcode || shipping.postcode || ''}, ${billing.country || shipping.country || ''}

اللوكيشن: ${billing.location || shipping.location || 'Not Found'}

المنطقة: ${billing.zone_name || shipping.zone_name || 'Unspecified'}

الاجمالي: ${parseFloat(order.total || 0).toFixed(2)} ${order.currency || ''}

            `.trim();
            if (!forWhatsApp) { navigator.clipboard.writeText(address).then(() => { showNotification('Address copied', 'success'); }).catch(err => { console.error('Failed to copy address: ', err); showNotification('Failed to copy address.', 'error'); }); }
            return address;
        }

        function copyOrder(order, forWhatsApp = false) {
            const billing = order.billing || {}; const shipping = order.shipping || {};
            const orderDetails = `
رقم الطلب #${order.id || 'N/A'}

العميل: ${billing.first_name || shipping.first_name || ''}
${billing.last_name || shipping.last_name || ''}

الايميل: ${billing.email || 'N/A'}

رقم الهاتف: ${billing.phone || 'N/A'}

العنوان: ${billing.address_1 || shipping.address_1 || ''},

${billing.city || shipping.city || ''}, ${billing.state || shipping.state || ''}, ${billing.postcode || shipping.postcode || ''}, ${billing.country || shipping.country || ''}

اللوكيشن: ${billing.location || shipping.location || 'Not Found'}

المنطقة: ${billing.zone_name || shipping.zone_name || 'Unspecified'}

الاجمالي: ${parseFloat(order.total || 0).toFixed(2)} ${order.currency || ''}

تاريخ الطلب: ${order.date_created ? new Date(order.date_created).toLocaleString() : 'N/A'}

المنتجات:
${(Array.isArray(order.line_items) ? order.line_items : []).map(item => `

- ${item.name || 'Unknown Product'} (x ${item.quantity || 0})`).join('') || '- No products'}
            `.trim();
            if (!forWhatsApp) { navigator.clipboard.writeText(orderDetails).then(() => { showNotification('Order details copied', 'success'); }).catch(err => { console.error('Failed to copy order details: ', err); showNotification('Failed to copy order details.', 'error'); }); }
            return orderDetails;
        }

        function sendToWhatsApp(order, type) {
            if (users.length === 0) { showNotification('No users available. Please add users in Settings.', 'warning'); return; }
            const userOptions = users.map(user => `<option value="${user.id}">${user.name} (${user.job || 'N/A'})</option>`).join('');
            Swal.fire({
                title: `Send ${type === 'address' ? 'Address' : 'Order'} to WhatsApp`,
                html: `<select id="swal-user" class="swal2-select"><option value="">Select a user</option>${userOptions}</select>`,
                showCancelButton: true, confirmButtonText: 'Send', cancelButtonText: 'Cancel', confirmButtonColor: '#10b981', cancelButtonColor: '#ef4444',
                preConfirm: () => { const userId = document.getElementById('swal-user').value; if (!userId) { Swal.showValidationMessage('Please select a user'); return false; } return userId; }
            }).then(result => {
                if (result.isConfirmed) {
                    const user = users.find(u => u.id === result.value);
                    if (!user || !user.phone || !user.phone.startsWith(EGYPT_COUNTRY_CODE)) { showNotification('Selected user does not have a valid Egypt phone number starting with +20.', 'error'); return; }
                    const message = type === 'address' ? copyAddress(order, true) : copyOrder(order, true);
                    const encodedMessage = encodeURIComponent(message);
                    const phoneNumber = user.phone.replace(/[^0-9+]/g, '');
                    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                    window.open(whatsappUrl, '_blank');
                    showNotification(`${type === 'address' ? 'Address' : 'Order'} prepared for WhatsApp`, 'success');
                }
            });
        }

        function openStatusModal(orderId, currentStatus) {
            Swal.fire({ title: `Update Status for Order #${orderId}`, html: `<select id="swal-status" class="swal2-select"><option value="pending" ${currentStatus === 'pending' ? 'selected' : ''}>Pending Payment</option><option value="processing" ${currentStatus === 'processing' ? 'selected' : ''}>Processing</option><option value="on-hold" ${currentStatus === 'on-hold' ? 'selected' : ''}>On Hold</option><option value="completed" ${currentStatus === 'completed' ? 'selected' : ''}>Completed</option><option value="cancelled" ${currentStatus === 'cancelled' ? 'selected' : ''}>Cancelled</option><option value="refunded" ${currentStatus === 'refunded' ? 'selected' : ''}>Refunded</option><option value="failed" ${currentStatus === 'failed' ? 'selected' : ''}>Failed</option></select>`, showCancelButton: true, confirmButtonText: 'Save', cancelButtonText: 'Cancel', confirmButtonColor: '#10b981', cancelButtonColor: '#ef4444', preConfirm: () => document.getElementById('swal-status').value }).then(async (result) => { if (result.isConfirmed) { await updateStatus(orderId, result.value); } });
        }

        async function updateStatus(orderId, newStatus) {
            showLoading();
            try {
                const response = await fetch(`${storeUrl}/wp-json/wc/v3/orders/${orderId}`, { method: 'PUT', headers: { 'Authorization': 'Basic ' + btoa(`${consumer_key}:${consumer_secret}`), 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message}`); }
                await fetchOrders(localStorage.getItem('active-status-filter'));
                showNotification('Status updated successfully', 'success');
            } catch (error) { console.error('Error updating status:', error); showNotification(`Error updating status: ${error.message}`, 'error'); } finally { hideLoading(); }
        }

        let productsCache = null;
        async function fetchProductsCached() {
            if (productsCache) return productsCache;
            try {
                const response = await fetch(`${storeUrl}/wp-json/wc/v3/products?per_page=100&status=publish&stock_status=instock`, { headers: { 'Authorization': 'Basic ' + btoa(`${consumer_key}:${consumer_secret}`) } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} fetching products`);
                productsCache = await response.json(); return productsCache;
            } catch (error) { console.error('Error fetching products:', error); showNotification('Error fetching products list', 'error'); return []; }
        }

        async function openProductsModal(orderId, lineItems) {
            showLoading(); let currentProducts = JSON.parse(JSON.stringify(lineItems || [])); let allStoreProducts = await fetchProductsCached(); hideLoading();
            if (!allStoreProducts || allStoreProducts.length === 0) { showNotification('Could not load product list.', 'error'); return; }
            function generateProductFields(item, index) { const productDetail = allStoreProducts.find(p => p.id === item.product_id) || {}; const imageSrc = item.image?.src || productDetail.images?.[0]?.src || ''; const imageAlt = item.name || productDetail.name || 'Product'; return `<div class="product-item modal-product-item" data-index="${index}" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #eee;">${imageSrc ? `<img src="${imageSrc}" alt="${imageAlt}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;" loading="lazy" />` : '<div style="width: 50px; height: 50px; background: #eee; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #aaa;"><i class="fas fa-image"></i></div>'}<div style="flex: 1;"><strong>${item.name || 'Unknown Product'}</strong> (ID: ${item.product_id || item.id})<div><label>Quantity:</label><input type="number" value="${item.quantity || 0}" id="quantity-${index}" min="0" style="width: 70px; margin-left: 8px; padding: 6px; border: 1px solid #ccc; border-radius: 6px;"></div></div><button class="remove-product-btn" data-index="${index}" style="background: #ef4444; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;"><i class="fas fa-trash"></i></button></div>`; }
            const generateProductList = () => currentProducts.map((item, index) => generateProductFields(item, index)).join('') || '<p style="text-align: center; color: grey;">No products.</p>';
            function updateProductListUI(formElement) { formElement.innerHTML = generateProductList(); }
            async function addProduct() {
                const productOptions = allStoreProducts.sort((a, b) => (a.name || '').localeCompare(b.name || '')).map(product => `<option value="${product.id}">${product.name || 'Unknown Product'} (ID: ${product.id})</option>`).join('');
                Swal.fire({ title: 'Add Product', html: `<select id="swal-product-id" class="swal2-select" style="width: 100%; margin-bottom: 10px;"><option value="">Select product</option>${productOptions}</select><input type="number" id="swal-quantity" placeholder="Quantity" min="1" value="1" class="swal2-input" style="width: 100%;">`, showCancelButton: true, confirmButtonText: 'Add', cancelButtonText: 'Cancel', confirmButtonColor: '#10b981', cancelButtonColor: '#ef4444', didOpen: () => { document.getElementById('swal-product-id').focus(); }, preConfirm: () => { const productId = document.getElementById('swal-product-id').value; const quantity = parseInt(document.getElementById('swal-quantity').value) || 1; if (!productId) { Swal.showValidationMessage('Select product'); return false; } if (quantity <= 0) { Swal.showValidationMessage('Quantity >= 1'); return false; } const selectedProduct = allStoreProducts.find(p => p.id == productId); if (!selectedProduct) { Swal.showValidationMessage('Product not found'); return false; } const existingProductIndex = currentProducts.findIndex(p => p.product_id == productId); if (existingProductIndex > -1) { currentProducts[existingProductIndex].quantity += quantity; return { updatedExisting: true }; } else { return { product_id: selectedProduct.id, name: selectedProduct.name || 'Unknown Product', quantity: quantity, price: selectedProduct.price || 0, image: selectedProduct.images?.[0] || null }; } } }).then(result => { if (result.isConfirmed) { if (result.value && !result.value.updatedExisting) { currentProducts.push(result.value); } const form = document.getElementById('edit-products-form'); if (form) { updateProductListUI(form); } } });
            }
            const { value: finalProductsToSave } = await Swal.fire({ title: `Edit Products for Order #${orderId}`, html: `<div id="edit-products-form" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 15px; padding: 10px; text-align: left;">${generateProductList()}</div><button id="add-product-btn-swal" type="button" style="background: #10b981; color: #fff; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;"><i class="fas fa-plus"></i> Add Product</button>`, showCancelButton: true, confirmButtonText: 'Save Changes', cancelButtonText: 'Cancel', confirmButtonColor: '#10b981', cancelButtonColor: '#ef4444', width: '80%', didOpen: () => { const form = Swal.getPopup().querySelector('#edit-products-form'); const addButton = Swal.getPopup().querySelector('#add-product-btn-swal'); form.addEventListener('click', (e) => { const removeButton = e.target.closest('.remove-product-btn'); if (removeButton) { const index = parseInt(removeButton.getAttribute('data-index')); if (!isNaN(index) && index >= 0 && index < currentProducts.length) { currentProducts.splice(index, 1); updateProductListUI(form); } } }); addButton.addEventListener('click', addProduct); }, preConfirm: () => { const updatedProducts = currentProducts.map((item, index) => { const quantityInput = Swal.getPopup().querySelector(`#quantity-${index}`); const newQuantity = quantityInput ? (parseInt(quantityInput.value) || 0) : item.quantity; return { ...item, quantity: newQuantity }; }); return updatedProducts.filter(item => item.quantity > 0); } });
            if (finalProductsToSave) { await saveProducts(orderId, finalProductsToSave); }
        }

        async function saveProducts(orderId, productsToSave) {
            showLoading();
            try { 
                const updatedLineItems = productsToSave.map(item => ({ id: item.id || 0, product_id: item.product_id, quantity: item.quantity }));
                const response = await fetch(`${storeUrl}/wp-json/wc/v3/orders/${orderId}`, { method: 'PUT', headers: { 'Authorization': 'Basic ' + btoa(`${consumer_key}:${consumer_secret}`), 'Content-Type': 'application/json' }, body: JSON.stringify({ line_items: updatedLineItems }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Failed to update line items'}`); }
                await fetchOrders(localStorage.getItem('active-status-filter'));
                showNotification('Order products updated successfully', 'success');
            } catch (error) { console.error('Error saving products:', error); showNotification(`Error saving products: ${error.message}`, 'error'); } finally { hideLoading(); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const customerFilterInput = document.getElementById('customer-filter'); if (customerFilterInput) customerFilterInput.addEventListener('input', debouncedSaveFiltersAndFetch);
            const saveSettingsButton = document.getElementById('save-settings-btn'); if (saveSettingsButton) { saveSettingsButton.addEventListener('click', () => { saveFiltersAndFetch(); toggleSettings(); showNotification('Filters applied', 'success'); }); }
            const clearFiltersButton = document.getElementById('clear-filters-btn'); if (clearFiltersButton) clearFiltersButton.addEventListener('click', clearFiltersAndFetch); // Added listener for clear button
            const addUserButton = document.getElementById('add-user-btn'); if (addUserButton) addUserButton.addEventListener('click', addUser);
            const statusCheckboxes = document.querySelectorAll('input[name="status-filter"]'); statusCheckboxes.forEach(checkbox => checkbox.addEventListener('change', debouncedSaveFiltersAndFetch));
            ['date-from', 'date-to', 'per-page', 'sort-by'].forEach(id => { const element = document.getElementById(id); if (element) element.addEventListener('change', debouncedSaveFiltersAndFetch); });
            initialize();
        });

        async function initialize() {
            showLoading();
            loadFilters();
            loadUsers(); // Renamed
            await fetchOrders(localStorage.getItem('active-status-filter'));
        }

    </script>
</body>
</html> 
